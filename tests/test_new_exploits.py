#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Tests for new CVE exploits
"""

import unittest
import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from exploits.cve_2025_49741 import CVE2025_49741_Exploit
from exploits.cve_2020_6519 import CVE2020_6519_Exploit
from exploits.cve_2017_5375 import CVE2017_5375_Exploit
from modules.obfuscation.cve_obfuscation_variants import CVEObfuscationVariants


class TestCVE2025_49741(unittest.TestCase):
    """Tests for CVE-2025-49741 exploit"""
    
    def setUp(self):
        self.exploit = CVE2025_49741_Exploit()
    
    def test_exploit_initialization(self):
        """Test exploit initialization"""
        self.assertIsNotNone(self.exploit)
        self.assertIsNotNone(self.exploit.config)
        self.assertEqual(self.exploit.config['malicious_port'], 8080)
        self.assertEqual(self.exploit.config['exfil_port'], 1337)
    
    def test_parameter_setting(self):
        """Test parameter setting"""
        self.exploit.set_parameter('malicious_port', 9090)
        self.assertEqual(self.exploit.config['malicious_port'], 9090)
    
    def test_payload_generation(self):
        """Test payload generation"""
        payload = self.exploit.generate_payload()
        self.assertIsInstance(payload, str)
        self.assertIn('CVE-2025-49741', payload)
        self.assertIn('exfiltrateData', payload)
    
    def test_local_ip_detection(self):
        """Test local IP detection"""
        ip = self.exploit._get_local_ip()
        self.assertIsNotNone(ip)
        self.assertIsInstance(ip, str)
        self.assertIn('.', ip)  # Should be an IP address


class TestCVE2020_6519(unittest.TestCase):
    """Tests for CVE-2020-6519 exploit"""
    
    def setUp(self):
        self.exploit = CVE2020_6519_Exploit()
    
    def test_exploit_initialization(self):
        """Test exploit initialization"""
        self.assertIsNotNone(self.exploit)
        self.assertIsNotNone(self.exploit.config)
        self.assertEqual(self.exploit.config['port'], 8080)
    
    def test_payload_generation(self):
        """Test payload generation"""
        payload = self.exploit.generate_payload()
        self.assertIsInstance(payload, str)
        self.assertIn('CVE-2020-6519', payload)
        self.assertIn('javascript:', payload)
    
    def test_bypass_attempts_tracking(self):
        """Test bypass attempts tracking"""
        self.assertEqual(len(self.exploit.bypass_attempts), 0)
        self.exploit.bypass_attempts.append({'type': 'test', 'timestamp': 123456})
        self.assertEqual(len(self.exploit.bypass_attempts), 1)


class TestCVE2017_5375(unittest.TestCase):
    """Tests for CVE-2017-5375 exploit"""
    
    def setUp(self):
        self.exploit = CVE2017_5375_Exploit()
    
    def test_exploit_initialization(self):
        """Test exploit initialization"""
        self.assertIsNotNone(self.exploit)
        self.assertIsNotNone(self.exploit.config)
        self.assertEqual(self.exploit.config['target_firefox_version'], '44.0.2')
    
    def test_payload_generation(self):
        """Test payload generation"""
        payload = self.exploit.generate_payload()
        self.assertIsInstance(payload, str)
        self.assertIn('asm', payload.lower())
        self.assertIn('spray', payload.lower())
    
    def test_float_constants_generation(self):
        """Test float constants generation"""
        constants = self.exploit._generate_float_constants()
        self.assertIsInstance(constants, str)
        self.assertIn(',', constants)  # Should have multiple constants


class TestObfuscationVariants(unittest.TestCase):
    """Tests for obfuscation variants"""
    
    def setUp(self):
        self.obfuscator = CVEObfuscationVariants()
        self.test_payload = "var test = 'hello'; function testFunc() { return test; }"
    
    def test_cve_2025_49741_obfuscation(self):
        """Test CVE-2025-49741 obfuscation"""
        for variant in range(1, 6):
            obfuscated = self.obfuscator.obfuscate_cve_2025_49741(self.test_payload, variant)
            self.assertIsInstance(obfuscated, str)
            self.assertNotEqual(obfuscated, self.test_payload)  # Should be different
    
    def test_cve_2020_6519_obfuscation(self):
        """Test CVE-2020-6519 obfuscation"""
        test_payload = "document.createElement('iframe'); iframe.src = 'javascript:alert(1)';"
        for variant in range(1, 6):
            obfuscated = self.obfuscator.obfuscate_cve_2020_6519(test_payload, variant)
            self.assertIsInstance(obfuscated, str)
    
    def test_cve_2017_5375_obfuscation(self):
        """Test CVE-2017-5375 obfuscation"""
        test_payload = "var val = 0.0; val = +foo(1.234e-10, 2.345e+20);"
        for variant in range(1, 6):
            obfuscated = self.obfuscator.obfuscate_cve_2017_5375(test_payload, variant)
            self.assertIsInstance(obfuscated, str)
    
    def test_generate_all_variants(self):
        """Test generating all variants"""
        variants = self.obfuscator.generate_all_variants('CVE-2025-49741', self.test_payload, 5)
        self.assertEqual(len(variants), 5)
        for variant_name, variant_code in variants.items():
            self.assertIn('CVE-2025-49741', variant_name)
            self.assertIsInstance(variant_code, str)


class TestExploitIntegration(unittest.TestCase):
    """Integration tests for exploits"""
    
    def test_exploit_registry(self):
        """Test exploit registry"""
        from exploits import EXPLOITS
        
        self.assertIn('CVE-2025-49741', EXPLOITS)
        self.assertIn('CVE-2020-6519', EXPLOITS)
        self.assertIn('CVE-2017-5375', EXPLOITS)
    
    def test_exploit_imports(self):
        """Test exploit imports"""
        from exploits import CVE2025_49741_Exploit, CVE2020_6519_Exploit, CVE2017_5375_Exploit
        
        self.assertIsNotNone(CVE2025_49741_Exploit)
        self.assertIsNotNone(CVE2020_6519_Exploit)
        self.assertIsNotNone(CVE2017_5375_Exploit)


if __name__ == '__main__':
    unittest.main()
